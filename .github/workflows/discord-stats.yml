name: Update Discord stats

permissions:
  contents: write

on:
  schedule:
    # every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: {}

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch Discord invite counts (only write on change)
        env:
          INVITE: pcqA6JaeWK
        run: |
          node <<'NODE'
          const https = require('https');
          const fs = require('fs');
          const path = 'data/discord-stats.json';
          const url = `https://discord.com/api/v10/invites/${process.env.INVITE}?with_counts=true`;

          function fetchJson(u){
            return new Promise((resolve, reject)=>{
              https.get(u, res=>{
                let d='';
                res.on('data', c=> d+=c);
                res.on('end', ()=>{
                  try{ resolve(JSON.parse(d)); }catch(e){ reject(e); }
                });
              }).on('error', reject);
            });
          }

          (async ()=>{
            try{
              const j = await fetchJson(url);
              const out = { total: j.approximate_member_count || 0, online: j.approximate_presence_count || 0, fetched_at: new Date().toISOString() };

              let existing = null;
              if(fs.existsSync(path)){
                try{ existing = JSON.parse(fs.readFileSync(path,'utf8')); }catch(e){ existing = null; }
              }

              const changed = !existing || existing.total !== out.total || existing.online !== out.online;
              if(changed){
                fs.mkdirSync('data',{recursive:true});
                fs.writeFileSync(path, JSON.stringify(out, null, 2));
                console.log('Discord stats changed — wrote', JSON.stringify(out));
                process.exit(0);
              }else{
                console.log('No change in Discord stats (total/online identical) — skipping write');
                process.exit(0);
              }
            }catch(e){
              console.error('Failed to fetch or write discord stats', e);
              process.exit(1);
            }
          })();
          NODE

      - name: Commit and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/discord-stats.json
          git commit -m "Update discord stats" || echo "no changes to commit"
          git push origin HEAD:main
